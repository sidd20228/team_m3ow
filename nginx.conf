# A minimal, failsafe configuration for OpenResty

# --- Process and Logging ---
worker_processes 1;
error_log C:/openresty/logs/error.log info;
pid C:/openresty/logs/nginx.pid;

# --- Connection Handling ---
events {
    worker_connections 1024;
}

# --- HTTP Server Definitions ---
http {
    # WORKAROUND: Disabled because the mime.types file cannot be found.
    # This is okay for a pure proxy setup.
    # include       mime.types.default;
    
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout  65;

    # Upstream for your application on port 3000
    upstream real_application {
        server 127.0.0.1:3000;
    }

    # The ONLY server block that will be active
    server {
        listen 80;
        server_name localhost;

        location / {
            # --- WAF is now ENABLED ---
            access_by_lua_file C:/openresty/nginx/lua/waf_chain.lua;

            # This is the only rule. It MUST pass to your application.
            proxy_pass http://real_application;

            # --- Standard proxy headers ---
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}